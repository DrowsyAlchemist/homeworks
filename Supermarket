using System;
using System.Collections.Generic;

namespace Lessons
{
    class Lessons
    {
        public static void Main()
        {
            Product[] products = GetProducts();
            Dictionary<string, int> prices = GetRandomPrices(products);
            Queue<Customer> customers = GetRandomCustomersQueue(products);
            Store store = new Store(prices, customers);
            store.ServeCustomers();
        }

        private static Product[] GetProducts()
        {
            return new Product[] {
                new Product("Хлеб"),
                new Product("Колбаса"),
                new Product("Сыр"),
                new Product("Масло"),
                new Product("Мясо"),
                new Product("Рыба"),
                new Product("Приправы"),
            };
        }

        private static Dictionary<string, int> GetRandomPrices(Product[] products)
        {
            Random random = new Random();
            int priceLowerBound = 100;
            int priceUpperBound = 1000;
            Dictionary<string, int> prices = new Dictionary<string, int>();

            foreach (Product product in products)
                prices.Add(product.Name, random.Next(priceLowerBound, priceUpperBound));

            return prices;
        }

        private static Queue<Customer> GetRandomCustomersQueue(Product[] products)
        {
            Random random = new Random();
            string inputData;
            int customersCount = 0;
            bool isCorrectCustomersCount = false;

            while (isCorrectCustomersCount == false)
            {
                Console.Write("Введите число покупателей: ");
                inputData = Console.ReadLine();
                isCorrectCustomersCount = int.TryParse(inputData, out customersCount);
            }
            Queue<Customer> customers = new Queue<Customer>();

            for (int i = 0; i < customersCount; i++)
                customers.Enqueue(GetRandomCustomer(products, random));

            return customers;
        }

        private static Customer GetRandomCustomer(Product[] products, Random random)
        {
            int moneyUpperBound = 4000;
            int customerMoney = random.Next(moneyUpperBound);
            Customer customer = new Customer(customerMoney);
            int productsCountUpperBound = 7;
            int productsCountLowerBound = 1;
            int customerProductsCount = random.Next(productsCountLowerBound, productsCountUpperBound);
            int productNumber;

            for (int i = 0; i < customerProductsCount; i++)
            {
                productNumber = random.Next(products.Length);
                Product customerProduct = products[productNumber].Clone();
                customer.AddProduct(customerProduct);
            }
            return customer;
        }
    }

    class Customer
    {
        private static Random _random = new Random();
        private int _money;
        private List<Product> _shoppingCart = new List<Product>();

        public Customer(int money)
        {
            _money = money;
        }

        public void AddProduct(Product product)
        {
            if (product != null)
                _shoppingCart.Add(product);
        }

        public List<Product> GetShoppingCart()
        {
            List<Product> products = new List<Product>();

            foreach (Product product in _shoppingCart)
                products.Add(product);

            return products;
        }

        public int GiveMoney(int requiredMoney)
        {
            if (IsEnoughMoney(requiredMoney))
            {
                _money -= requiredMoney;
                return requiredMoney;
            }
            else
            {
                return 0;
            }
        }

        public void RemoveRandomProduct()
        {
            int productNumber = _random.Next(0, _shoppingCart.Count);
            Console.WriteLine($"Покупатель выложил товар: {_shoppingCart[productNumber].Name}.");
            _shoppingCart.RemoveAt(productNumber);
        }

        private bool IsEnoughMoney(int moneyToPay)
        {
            return (moneyToPay <= _money);
        }
    }

    class Store
    {
        private int _money;
        private Dictionary<string, int> _prices;
        private Queue<Customer> _customers;

        public Store(Dictionary<string, int> prices, Queue<Customer> customers)
        {
            _prices = prices;
            _customers = customers;
        }

        public void ServeCustomers()
        {
            Console.Clear();
            int customerNumber = 1;

            while (_customers.Count > 0)
            {
                Console.WriteLine($"Покупатель_{customerNumber++}:");
                ServeCustomer(_customers.Dequeue());
                Console.ReadKey(true);
            }
            Console.Clear();
            Console.WriteLine($"Все покупатели обслужены. Выручка магазина: {_money} руб.");
            Console.ReadKey(true);
        }

        private void ServeCustomer(Customer customer)
        {
            List<Product> customerProducts = customer.GetShoppingCart();
            ShowCustomerProducts(customerProducts);
            bool customerIsServed = false;

            while (!customerIsServed)
            {
                customerIsServed = TrySellProducts(customerProducts, customer);

                if (!customerIsServed)
                {
                    Console.Write("У покупателя недостаточно денег. ");
                    customer.RemoveRandomProduct();
                    customerProducts = customer.GetShoppingCart();
                }
            }
        }

        private void ShowCustomerProducts(List<Product> customerProducts)
        {
            Console.WriteLine("Корзина покупателя:");

            foreach (Product product in customerProducts)
                Console.WriteLine($"{product.Name,-8} - {_prices[product.Name]} руб.");
        }

        private bool TrySellProducts(List<Product> customerProducts, Customer customer)
        {
            if (customerProducts.Count == 0)
            {
                Console.WriteLine("Покупатель уходит без покупок.\n");
                return true;
            }
            int totalСost = GetTotalCost(customerProducts);
            int moneyFromCustomer = customer.GiveMoney(totalСost);

            if (moneyFromCustomer == totalСost)
            {
                TakeMoney(moneyFromCustomer);
                Console.WriteLine($"Клиент обслужен. Сумма покупки: {totalСost} руб.\n");
                return true;
            }
            else
            {
                return false;
            }
        }

        private int GetTotalCost(List<Product> customerProducts)
        {
            int totalCost = 0;

            foreach (Product product in customerProducts)
                totalCost += _prices[product.Name];

            return totalCost;
        }

        private void TakeMoney(int money)
        {
            if (money < 0)
                throw new ArgumentException();

            _money += money;
        }
    }

    class Product
    {
        public string Name { get; private set; }

        public Product(string name)
        {
            Name = name;
        }

        public Product Clone()
        {
            return new Product(Name);
        }
    }
}
