using System;
using System.Collections.Generic;

namespace Lessons
{
    class Lessons
    {
        public static void Main()
        {
            Player player = new Player("Mark");
            TravelingMerchant travelingMerchant = new TravelingMerchant("Merchant");
            Item apple = new Item("Яблоко", "Восстанавливает 10 здоровья", 5);
            Item bread = new Item("Хлеб", "Неплохо утоляет голод", 2);
            Item hammer = new Item("Молоток", "Можно забивать им гвозди или использовать в качестве оружия", 10);
            Item rustySward = new Item("Ржавый меч", "Ржавый и тупой, но это лучше, чем ничего", 15);
            travelingMerchant.TakeItem(hammer);
            travelingMerchant.TakeItem(bread);
            player.TakeItem(apple);
            player.TakeItem(rustySward);
            Trade trade = new Trade(player, travelingMerchant);
            trade.Perform();
        }
    }

    abstract class Trader
    {
        public abstract void ShowInventory();
        public abstract void ShowItems();
        public abstract void BuyItemFromPlayer(Item item, Player player);
        public abstract void SellItemToPlayer(int itemNumber, Player player);
    }

    static class Logger
    {
        public static void PrintMessage(string message, ConsoleColor color)
        {
            ConsoleColor defaultColor = Console.ForegroundColor;
            Console.ForegroundColor = color;
            Console.WriteLine(message);
            Console.ForegroundColor = defaultColor;
        }
    }

    class Trade
    {
        private Player _player;
        private Trader _trader;
        private int _tradeItemNumber;

        public Trade(Player player, Trader trader)
        {
            _player = player;
            _trader = trader;
        }

        public void Perform()
        {
            string inputData = string.Empty;

            while (inputData != "5")
            {
                Console.WriteLine(
                    "1. Посмотреть товары продавца\n" +
                    "2. Открыть инвентарь\n" +
                    "3. Купить\n" +
                    "4. Продать\n" +
                    "5. Выйти\n");
                inputData = Console.ReadLine();
                Console.Clear();

                switch (inputData)
                {
                    case "1":
                        _trader.ShowInventory();
                        break;
                    case "2":
                        _player.ShowInventory();
                        break;
                    case "3":
                        SellItemToPlayer();
                        break;
                    case "4":
                        BuyItemFromPlayer();
                        break;
                }
                Console.ReadKey(true);
                Console.Clear();
            }
        }

        private void SellItemToPlayer()
        {
            _trader.ShowItems();
            Console.Write("Выберите предмет для покупки: ");
            _tradeItemNumber = GetItemNumber();
            _trader.SellItemToPlayer(_tradeItemNumber, _player);
        }

        private void BuyItemFromPlayer()
        {
            _player.ShowItems();
            Console.Write("Выберите предмет для продажи: ");
            _tradeItemNumber = GetItemNumber();
            if (IsInvalidItemNumber(_tradeItemNumber, _player))
            {
                Logger.PrintMessage("\nПредмет не найден.", ConsoleColor.Red);
            }
            else
            {
                Item tradeItem = _player.DropItem(_tradeItemNumber);
                _trader.BuyItemFromPlayer(tradeItem, _player);
            }
        }

        private int GetItemNumber()
        {
            int.TryParse(Console.ReadLine(), out int itemNumber);
            return itemNumber;
        }

        private bool IsInvalidItemNumber(int itemNumber, Player player)
        {
            return (itemNumber <= 0) || (itemNumber > player.ItemsCount);
        }
    }

    class Player
    {
        private const int InitialMoney = 15;
        private List<Item> _inventory = new List<Item>();
        private int _money;

        public string Name { get; private set; }
        public int ItemsCount => _inventory.Count;

        public Player(string name)
        {
            Name = name;
            _money = InitialMoney;
        }

        public Player(string name, int money)
        {
            if (money < 0)
                throw new ArgumentException();

            Name = name;
            _money = money;
        }

        public void ShowInventory()
        {
            Console.WriteLine("Ваш инвентарь:\n");
            Console.WriteLine($"Деньги: {_money}\n");
            ShowItems();
        }

        public void ShowItems()
        {
            for (int i = 0; i < _inventory.Count; i++)
            {
                Console.Write($"{i + 1}. ");
                _inventory[i].ShowInfo();
            }
        }

        public void TakeItem(Item item)
        {
            _inventory.Add(item);
        }

        public Item DropItem(int itemNumber)
        {
            Item itemToDrop = _inventory[itemNumber - 1];
            _inventory.RemoveAt(itemNumber - 1);
            return itemToDrop;
        }

        public void TakeMoney(int money)
        {
            if (money < 0)
                throw new ArgumentException();

            _money += money;
        }

        public bool TryGiveMoney(int requiredMoney)
        {
            if (requiredMoney < 0)
                throw new ArgumentException();

            if (NotEnoughMoney(requiredMoney))
                return false;

            _money -= requiredMoney;
            return true;
        }

        private bool NotEnoughMoney(int requiredMoney)
        {
            return _money < requiredMoney;
        }
    }

    class TravelingMerchant : Trader
    {
        private const int MaxPercent = 100;
        private const int InitialProfitInPercent = 120;
        private const int InitialMoney = 30;
        private List<Item> _itemsForSell = new List<Item>();
        private int _profitInPercent;
        private int _money;

        public string Name { get; private set; }
        public int ItemsCount => _itemsForSell.Count;

        public TravelingMerchant(string name)
        {
            Name = name;
            _profitInPercent = InitialProfitInPercent;
            _money = InitialMoney;
        }

        public TravelingMerchant(string name, int profitInPercent, int money)
        {
            if (money < 0)
                throw new ArgumentException();

            if (profitInPercent < 100)
                throw new ArgumentException("Накрутка продавца должна быть больше или равна 100%");

            Name = name;
            _profitInPercent = profitInPercent;
            _money = money;
        }

        public override void BuyItemFromPlayer(Item item, Player player)
        {
            if (TryGiveMoneyToPlayer(item.Cost, player) == false)
            {
                Logger.PrintMessage("\nУ торговца недостаточно денег.", ConsoleColor.Red);
                player.TakeItem(item);
                return;
            }
            TakeItem(item);
            Logger.PrintMessage($"\nВы продали {item.Name} за {item.Cost} монет.", ConsoleColor.Green);
        }

        public void TakeItem(Item item)
        {
            _itemsForSell.Add(item);
        }

        public override void SellItemToPlayer(int itemNumber, Player player)
        {
            if (ItemIsNotFound(itemNumber))
            {
                Logger.PrintMessage("\nТовар не найден.", ConsoleColor.Red);
                return;
            }
            int itemPrice = GetPriсe(itemNumber);


            if (player.TryGiveMoney(itemPrice) == false)
            {
                Logger.PrintMessage("\nУ вас недостаточно денег для покупки.", ConsoleColor.Red);
                return;
            }
            Item itemToSell = DropItem(itemNumber);
            player.TakeItem(itemToSell);
            _money += itemPrice;
            Logger.PrintMessage($"\nВы купили {itemToSell.Name} за {itemPrice} монет.", ConsoleColor.Green);
        }

        public override void ShowInventory()
        {
            Console.WriteLine($"Деньги продавца: {_money}\n");
            ShowItems();
        }

        public override void ShowItems()
        {
            Console.WriteLine("Товары продавца:\n");

            for (int i = 0; i < _itemsForSell.Count; i++)
            {
                Console.Write($"{i + 1}. ");
                Console.WriteLine($"{_itemsForSell[i].Name}: {_itemsForSell[i].Description}. Стоимость: {GetPriсe(i + 1)}\n");
            }
        }

        private int GetPriсe(int itemNumber)
        {
            int itemPrice = (int)(_itemsForSell[itemNumber - 1].Cost * (double)_profitInPercent / MaxPercent);
            return itemPrice + 1;
        }

        private Item DropItem(int itemNumber)
        {
            Item itemToDrop = _itemsForSell[itemNumber - 1];
            _itemsForSell.RemoveAt(itemNumber - 1);
            return itemToDrop;
        }

        private bool ItemIsNotFound(int itemNumber)
        {
            return (itemNumber <= 0) || (itemNumber > _itemsForSell.Count);
        }

        private bool TryGiveMoneyToPlayer(int requiredMoney, Player player)
        {
            if (requiredMoney < 0)
                throw new ArgumentException();

            if (NotEnoughMoney(requiredMoney))
                return false;

            _money -= requiredMoney;
            player.TakeMoney(requiredMoney);
            return true;
        }

        private bool NotEnoughMoney(int requiredMoney)
        {
            return _money < requiredMoney;
        }
    }

    class Item
    {
        public string Name { get; private set; }
        public string Description { get; private set; }
        public int Cost { get; private set; }

        public Item(string name, string description, int cost)
        {
            Name = name;
            Description = description;
            Cost = cost;
        }

        public void ShowInfo()
        {
            Console.WriteLine($"{Name}: {Description}. Стоимость: {Cost}\n");
        }
    }
}
