using System;
using System.Collections.Generic;

namespace Lessons
{
    class Lessons
    {
        public static void Main()
        {
            Player player = new Player("Mark");
            TravelingMerchant travelingMerchant = new TravelingMerchant("Merchant");
            Item apple = new Item("Яблоко", "Восстанавливает 10 здоровья", 5);
            Item bread = new Item("Хлеб", "Неплохо утоляет голод", 2);
            Item hammer = new Item("Молоток", "Можно забивать им гвозди или использовать в качестве оружия", 10);
            Item rustySward = new Item("Ржавый меч", "Ржавый и тупой, но это лучше, чем ничего", 15);
            travelingMerchant.TakeItem(hammer);
            travelingMerchant.TakeItem(bread);
            player.TakeItem(apple);
            player.TakeItem(rustySward);
            Trade trade = new Trade(player, travelingMerchant);
            trade.Perform();
        }
    }

    static class Logger
    {
        public static void PrintMessage(string message, ConsoleColor color)
        {
            ConsoleColor defaultColor = Console.ForegroundColor;
            Console.ForegroundColor = color;
            Console.WriteLine(message);
            Console.ForegroundColor = defaultColor;
        }
    }

    class Trade
    {
        private Player _player;
        private Trader _trader;
        private int _tradeItemNumber;

        public Trade(Player player, Trader trader)
        {
            _player = player;
            _trader = trader;
        }

        public void Perform()
        {
            string inputData = string.Empty;

            while (inputData != "5")
            {
                Console.WriteLine(
                    "1. Посмотреть товары продавца\n" +
                    "2. Открыть инвентарь\n" +
                    "3. Купить\n" +
                    "4. Продать\n" +
                    "5. Выйти\n");
                inputData = Console.ReadLine();
                Console.Clear();

                switch (inputData)
                {
                    case "1":
                        _trader.ShowInventory();
                        break;
                    case "2":
                        _player.ShowInventory();
                        break;
                    case "3":
                        SellItemToPlayer();
                        break;
                    case "4":
                        BuyItemFromPlayer();
                        break;
                }
                Console.ReadKey(true);
                Console.Clear();
            }
        }

        private void SellItemToPlayer()
        {
            _trader.ShowItems();
            Console.Write("Выберите предмет для покупки: ");
            _tradeItemNumber = GetItemNumber();
            _trader.SellItemToPlayer(_tradeItemNumber, _player);
        }

        private void BuyItemFromPlayer()
        {
            _player.ShowItems();
            Console.Write("Выберите предмет для продажи: ");
            _tradeItemNumber = GetItemNumber();
            if (IsInvalidItemNumber(_tradeItemNumber, _player))
            {
                Logger.PrintMessage("\nПредмет не найден.", ConsoleColor.Red);
            }
            else
            {
                Item tradeItem = _player.DropItem(_tradeItemNumber);
                _trader.BuyItemFromPlayer(tradeItem, _player);
            }
        }

        private int GetItemNumber()
        {
            int.TryParse(Console.ReadLine(), out int itemNumber);
            return itemNumber;
        }

        private bool IsInvalidItemNumber(int itemNumber, Player player)
        {
            return (itemNumber <= 0) || (itemNumber > player.ItemsCount);
        }
    }

    abstract class Character
    {
        protected const int InitialMoney = 15;
        protected List<Item> Inventory = new List<Item>();
        protected int Money;

        public string Name { get; protected set; }
        public int ItemsCount => Inventory.Count;

        public void ShowInventory()
        {
            Console.WriteLine($"Деньги: {Money}\n");
            ShowItems();
        }

        public virtual void ShowItems()
        {
            Console.WriteLine("Предметы: \n");

            for (int i = 0; i < Inventory.Count; i++)
            {
                Console.Write($"{i + 1}. ");
                Inventory[i].ShowInfo();
            }
        }

        public void TakeItem(Item item)
        {
            Inventory.Add(item);
        }

        public Item DropItem(int itemNumber)
        {
            Item itemToDrop = Inventory[itemNumber - 1];
            Inventory.RemoveAt(itemNumber - 1);
            return itemToDrop;
        }

        public void TakeMoney(int money)
        {
            if (money < 0)
                throw new ArgumentException();

            Money += money;
        }

        public bool TryGiveMoneyToCharacter(int requiredMoney, Character character)
        {
            if (requiredMoney < 0)
                throw new ArgumentException();

            if (NotEnoughMoney(requiredMoney))
                return false;

            Money -= requiredMoney;
            character.TakeMoney(requiredMoney);
            return true;
        }

        protected bool NotEnoughMoney(int requiredMoney)
        {
            return Money < requiredMoney;
        }
    }

    abstract class Trader : Character
    {
        protected const int MaxPercent = 100;
        protected const int InitialProfitInPercent = 120;
        protected int ProfitInPercent;

        public abstract void BuyItemFromPlayer(Item item, Player player);
        public abstract void SellItemToPlayer(int itemNumber, Player player);
        protected virtual int GetPriсe(int itemNumber)
        {
            int itemPrice = (int)(Inventory[itemNumber - 1].Cost * (double)ProfitInPercent / MaxPercent);
            return itemPrice + 1;
        }
    }

    class Player : Character
    {
        public Player(string name)
        {
            Name = name;
            Money = InitialMoney;
        }

        public Player(string name, int money)
        {
            if (money < 0)
                throw new ArgumentException();

            Name = name;
            Money = money;
        }
    }

    class TravelingMerchant : Trader
    {
        public TravelingMerchant(string name)
        {
            Name = name;
            ProfitInPercent = InitialProfitInPercent;
            Money = InitialMoney;
        }

        public TravelingMerchant(string name, int profitInPercent, int money)
        {
            if (money < 0)
                throw new ArgumentException();

            if (profitInPercent < 100)
                throw new ArgumentException("Накрутка продавца должна быть больше или равна 100%");

            Name = name;
            ProfitInPercent = profitInPercent;
            Money = money;
        }

        public override void BuyItemFromPlayer(Item item, Player player)
        {
            if (TryGiveMoneyToCharacter(item.Cost, player) == false)
            {
                Logger.PrintMessage("\nУ торговца недостаточно денег.", ConsoleColor.Red);
                player.TakeItem(item);
                return;
            }
            TakeItem(item);
            Logger.PrintMessage($"\nВы продали {item.Name} за {item.Cost} монет.", ConsoleColor.Green);
        }

        public override void SellItemToPlayer(int itemNumber, Player player)
        {
            if (ItemIsNotFound(itemNumber))
            {
                Logger.PrintMessage("\nТовар не найден.", ConsoleColor.Red);
                return;
            }
            int itemPrice = GetPriсe(itemNumber);


            if (player.TryGiveMoneyToCharacter(itemPrice, this) == false)
            {
                Logger.PrintMessage("\nУ вас недостаточно денег для покупки.", ConsoleColor.Red);
                return;
            }
            Item itemToSell = DropItem(itemNumber);
            player.TakeItem(itemToSell);
            Logger.PrintMessage($"\nВы купили {itemToSell.Name} за {itemPrice} монет.", ConsoleColor.Green);
        }

        public override void ShowItems()
        {
            Console.WriteLine("Товары продавца:\n");

            for (int i = 0; i < Inventory.Count; i++)
            {
                Console.Write($"{i + 1}. ");
                Console.WriteLine($"{Inventory[i].Name}: {Inventory[i].Description}. Стоимость: {GetPriсe(i + 1)}\n");
            }
        }

        private bool ItemIsNotFound(int itemNumber)
        {
            return (itemNumber <= 0) || (itemNumber > Inventory.Count);
        }
    }

    class Item
    {
        public string Name { get; private set; }
        public string Description { get; private set; }
        public int Cost { get; private set; }

        public Item(string name, string description, int cost)
        {
            Name = name;
            Description = description;
            Cost = cost;
        }

        public void ShowInfo()
        {
            Console.WriteLine($"{Name}: {Description}. Стоимость: {Cost}\n");
        }
    }
}
